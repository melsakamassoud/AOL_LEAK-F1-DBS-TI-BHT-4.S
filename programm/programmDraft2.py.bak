import psycopg2
import pandas as pd
import matplotlib.pyplot as plt

# Host: 34.32.97.154
# passwort postgres: Ai];>{o,Tl/XJ4I[
# database name: postgres
# user: postgres

# Konfigurationsdaten für die Session
def connect_to_db():
    print("=== Database connection ===")
    host = input("Host: ")
    port = input("Port (default 5432): ") or "5432"
    dbname = input("Database name: ")
    user = input("User: ")
    password = input("Password: ")

# Verbindung aufbauen
    try:
        conn = psycopg2.connect(
            host=host,
            port=port,
            dbname=dbname,
            user=user,
            password=password,
            sslmode="require"   # Cloud SQL
        )
        print("✅ Connected successfully\n")
        return conn
    except Exception as e:
        print("❌ Connection failed:")
        print(e)
        return None

# run_query_loop - Programmschleife
# Query Eingabe und Abschicken und Empfangen
def run_query_loop(conn):
    print("=== SQL Query Mode ===")
    print("Enter SQL queries.")
    print("Type 'exit' to quit.\n")

    while True:
        # Query input - raus mit exit
        sql = input("SQL> ")

        if sql.lower() == "exit":
            break

        try:
            # Query an Cloud SQL Instanz ueber conn mit pd (pandas)
            # pandas dataframe: df
            df = pd.read_sql(sql, conn)

            if df.empty:
                print("Query executed successfully, no data returned.\n")
                continue

            print(df.head(), "\n")

            visualize(df)

        except Exception as e:
            print("❌ Query failed:")
            print(e, "\n")

# visualize Funktion
def visualize(df):
    print("=== Visualization ===")

    # Show columns with indices
    for i, col in enumerate(df.columns):
        print(f"{i}: {col} ({df[col].dtype})")

    choice = input("Visualize data? (y/n): ").lower()
    if choice != "y":
        print()
        return

    print("\nChart types:")
    print("1: Bar chart")
    print("2: Line chart")

    chart_type = input("Select chart type (1/2): ")

    # Select X column
    x_idx = input("Select X column (number): ")
    y_idx = input("Select Y column (number): ")

    try:
        x_col = df.columns[int(x_idx)]
        y_col = df.columns[int(y_idx)]
    except (ValueError, IndexError):
        print("❌ Invalid column selection\n")
        return

    plt.figure(figsize=(8, 5))

    if chart_type == "1":
        plt.bar(df[x_col].astype(str), df[y_col])
    elif chart_type == "2":
        plt.plot(df[x_col], df[y_col], marker="o")
    else:
        print("❌ Invalid chart type\n")
        return

    plt.xlabel(x_col)
    plt.ylabel(y_col)
    plt.title(f"{y_col} vs {x_col}")
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.show()
    print()



def main():
    conn = None
    # versuch solange zu connecten wie geht
    while conn is None:
        conn = connect_to_db()

    # Mache SQL-Anfragen und visualize solange kein exit vom user
    run_query_loop(conn)
    conn.close()
    print("Connection closed. Bye!")

if __name__ == "__main__":
    main()

